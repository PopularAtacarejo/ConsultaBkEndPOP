<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Painel de Consulta Moderno (Debug)</title>
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    :root {
      /* Esquema de Cores Claro (Verde/Vermelho) */
      --bg-light: #f8f9fa;
      --text-light: #212529;
      --accent-light: #28a745; /* Verde Principal */
      --accent-light-hover: #218838; /* Verde Mais Escuro */
      --focus-ring-light: #dc3545; /* Vermelho para Foco */
      --error-light: #dc3545; /* Cor de erro */
      --border-light: #dee2e6;
      --shadow-light: rgba(0, 0, 0, 0.1);
      --input-bg-light: #ffffff;
      --input-text-light: #495057;
      --table-header-bg-light: #e9ecef;
      --table-header-text-light: #495057;

      /* Esquema de Cores Escuro (Verde/Vermelho) */
      --bg-dark: #1a1a1a;
      --text-dark: #e9ecef;
      --accent-dark: #34c759; /* Verde Mais Claro para Contraste */
      --accent-dark-hover: #2ca34c;
      --focus-ring-dark: #ff4d4d; /* Vermelho Claro para Foco */
      --error-dark: #ff4d4d; /* Cor de erro */
      --border-dark: #495057;
      --shadow-dark: rgba(255, 255, 255, 0.1);
      --input-bg-dark: #2c2c2c;
      --input-text-dark: #ced4da;
      --table-header-bg-dark: #343a40;
      --table-header-text-dark: #f8f9fa;

      /* Cores Atuais (Inicia com Claro) */
      --bg: var(--bg-light);
      --text: var(--text-light);
      --accent: var(--accent-light);
      --accent-hover: var(--accent-light-hover);
      --focus-ring: var(--focus-ring-light);
      --error-color: var(--error-light);
      --border: var(--border-light);
      --shadow: var(--shadow-light);
      --input-bg: var(--input-bg-light);
      --input-text: var(--input-text-light);
      --table-header-bg: var(--table-header-bg-light);
      --table-header-text: var(--table-header-text-light);

      /* Transições */
      --transition-speed: 0.3s;
    }

    [data-theme='dark'] {
      --bg: var(--bg-dark);
      --text: var(--text-dark);
      --accent: var(--accent-dark);
      --accent-hover: var(--accent-dark-hover);
      --focus-ring: var(--focus-ring-dark);
      --error-color: var(--error-dark);
      --border: var(--border-dark);
      --shadow: var(--shadow-dark);
      --input-bg: var(--input-bg-dark);
      --input-text: var(--input-text-dark);
      --table-header-bg: var(--table-header-bg-dark);
      --table-header-text: var(--table-header-text-dark);
    }

    body {
      font-family: \'Inter\', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 1.5rem;
      transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
      line-height: 1.6;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
      transition: border-color var(--transition-speed) ease;
    }

    #tituloPainel {
        text-align: center;
        color: var(--accent);
        margin: 0 auto; /* Centraliza horizontalmente */
        font-size: 1.8rem; /* Tamanho ligeiramente maior */
        font-weight: 600;
        animation: fadeInDown 0.8s ease-out;
        transition: color var(--transition-speed) ease;
    }

    .filtros {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem; /* Espaçamento aumentado */
      margin-bottom: 1.5rem;
      padding: 1rem;
      background-color: var(--input-bg);
      border-radius: 12px; /* Bordas mais arredondadas */
      box-shadow: 0 4px 15px var(--shadow);
      transition: background-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
    }

    .filtros input, .filtros select, .filtros button {
      padding: 0.75rem 1rem; /* Padding ajustado */
      font-size: 0.95rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      background-color: var(--input-bg);
      color: var(--input-text);
      flex: 1;
      min-width: 180px; /* Largura mínima aumentada */
      transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease, background-color var(--transition-speed) ease, color var(--transition-speed) ease;
      outline: none;
    }

    .filtros input::placeholder, .filtros select::placeholder {
        color: var(--input-text);
        opacity: 0.7;
    }

    /* Foco com anel vermelho */
    .filtros input:focus, .filtros select:focus,
    .login input[type="text"]:focus, /* Atualizado para incluir o input de senha como text */
    button:focus,
    .flatpickr-input:focus {
      border-color: var(--focus-ring);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--focus-ring) 30%, transparent);
    }
    /* Ajuste específico para Flatpickr */
    .flatpickr-input:focus {
        border-color: var(--focus-ring) !important;
        box-shadow: 0 0 0 3px color-mix(in srgb, var(--focus-ring) 30%, transparent) !important;
    }


    button {
      padding: 0.75rem 1.2rem;
      font-size: 0.95rem;
      font-weight: 600; /* Fonte mais encorpada */
      border-radius: 8px;
      background: var(--accent);
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background-color var(--transition-speed) ease, transform 0.1s ease, box-shadow var(--transition-speed) ease;
      box-shadow: 0 2px 5px var(--shadow);
      display: inline-flex; /* Para alinhar ícones se adicionados */
      align-items: center;
      gap: 0.5rem;
    }

    button:hover {
      background-color: var(--accent-hover);
      box-shadow: 0 4px 10px var(--shadow);
      transform: translateY(-2px); /* Efeito sutil de elevação */
    }

    button:active {
        transform: translateY(0px); /* Retorna ao clicar */
        box-shadow: 0 2px 5px var(--shadow);
    }

    /* Estilos específicos para botões de ação */
    .action-buttons {
        margin-bottom: 1.5rem;
        display: flex;
        gap: 0.8rem;
        flex-wrap: wrap;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
      background-color: var(--input-bg);
      color: var(--text);
      border-radius: 12px;
      overflow: hidden; /* Para aplicar border-radius nas células */
      box-shadow: 0 4px 15px var(--shadow);
      transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
    }

    th, td {
      border-bottom: 1px solid var(--border);
      padding: 1rem 1.2rem; /* Padding aumentado */
      text-align: left;
      transition: border-color var(--transition-speed) ease;
      font-size: 0.9rem;
    }

    th {
      background-color: var(--table-header-bg);
      color: var(--table-header-text);
      font-weight: 600;
      text-transform: uppercase; /* Cabeçalhos em maiúsculas */
      letter-spacing: 0.5px;
      transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
    }

    tbody tr {
        transition: background-color 0.2s ease;
    }

    tbody tr:hover {
        background-color: color-mix(in srgb, var(--accent) 10%, var(--input-bg)); /* Destaque sutil no hover */
    }

    tbody tr:last-child td {
        border-bottom: none;
    }

    td a {
        color: var(--accent);
        text-decoration: none;
        font-weight: 500;
        transition: color var(--transition-speed) ease;
    }

    td a:hover {
        color: var(--accent-hover);
        text-decoration: underline;
    }

    .paginacao {
      margin: 2rem 0;
      text-align: center;
    }

    .paginacao button {
      margin: 0 0.3rem;
      min-width: 40px; /* Largura mínima para botões de página */
    }

    .paginacao button.active {
        background-color: var(--accent-hover);
        font-weight: bold;
        cursor: default;
        transform: none;
        box-shadow: 0 2px 5px var(--shadow);
    }

    /* Mensagem de erro na tabela */
    .table-message {
        text-align: center;
        padding: 2rem;
        font-style: italic;
        color: var(--error-color);
        font-weight: 500;
    }

    @media (max-width: 768px) {
      body { padding: 1rem; }
      header { flex-direction: column; gap: 1rem; text-align: center; }
      #tituloPainel { font-size: 1.5rem; }
      .filtros {
        flex-direction: column;
      }
      .filtros input, .filtros select, .filtros button {
          min-width: unset;
      }
      th, td { padding: 0.8rem; font-size: 0.85rem; }
      .action-buttons { justify-content: center; }
    }

    .hidden { display: none !important; }

    /* Animações */
    @keyframes fadeInDown {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* --- Estilos do Login --- */
    .login {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      max-width: 380px; /* Largura aumentada */
      margin: 5rem auto;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 16px; /* Mais arredondado */
      box-shadow: 0 10px 30px var(--shadow);
      padding: 2.5rem 2rem; /* Padding aumentado */
      text-align: center;
      animation: fadeInUp 0.8s ease-out;
      transition: background-color var(--transition-speed) ease, border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
    }

    .login h2 {
        color: var(--accent);
        margin-bottom: 0.8rem;
        font-weight: 600;
        transition: color var(--transition-speed) ease;
    }

    .login p {
        margin-bottom: 1.5rem;
        color: var(--text);
        opacity: 0.9;
        transition: color var(--transition-speed) ease;
    }

    /* Removido .password-container e .toggle-password */

    .login input[type="text"] /* Agora aplica-se ao input de senha */
    {
        padding: 0.8rem 1rem; /* Padding normal, sem espaço para ícone */
        border-radius: 8px;
        border: 1px solid var(--border);
        width: 100%;
        font-size: 1rem;
        box-sizing: border-box;
        margin-bottom: 1.5rem; /* Adicionado margin-bottom aqui */
        background-color: var(--bg);
        color: var(--text);
        transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease, background-color var(--transition-speed) ease, color var(--transition-speed) ease;
    }

    .login button {
        width: 100%;
        padding: 0.8rem 1.5rem;
        font-size: 1rem;
    }

    /* Spinner */
    #spinner {
        display: none; /* Começa escondido */
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.1rem;
        background-color: var(--input-bg);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1.5rem 2rem;
        z-index: 1000;
        box-shadow: 0 5px 20px var(--shadow);
        /* display: flex; /* Será setado via JS */
        align-items: center;
        gap: 1rem;
        transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease, border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
    }

    #spinner::before {
        content: \'\';
        display: block;
        width: 24px;
        height: 24px;
        border: 3px solid var(--accent);
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Notificação */
    .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--accent);
        color: #fff;
        padding: 1rem 1.5rem;
        border-radius: 10px;
        box-shadow: 0 4px 15px var(--shadow);
        z-index: 1100;
        font-size: 0.95rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.8rem;
        animation: slideInUp 0.5s ease-out;
    }

    @keyframes slideInUp {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    @keyframes slideOutDown {
        from { transform: translateY(0); opacity: 1; }
        to { transform: translateY(100%); opacity: 0; }
    }

    /* Gráfico */
    .chart-container {
        max-width: 1000px;
        margin: 2.5rem auto;
        padding: 1.5rem;
        background-color: var(--input-bg);
        border-radius: 12px;
        box-shadow: 0 4px 15px var(--shadow);
        transition: background-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
    }

    /* Ajustes Flatpickr */
    .flatpickr-calendar {
        background: var(--input-bg);
        border-radius: 8px;
        border: 1px solid var(--border);
        box-shadow: 0 5px 15px var(--shadow);
    }
    .flatpickr-day {
        color: var(--text);
    }
    .flatpickr-day:hover, .flatpickr-day.prevMonthDay:hover, .flatpickr-day.nextMonthDay:hover {
        background: color-mix(in srgb, var(--accent) 20%, transparent);
        border-color: transparent;
    }
    .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange {
        background: var(--accent);
        border-color: var(--accent);
        color: #fff;
    }
    .flatpickr-day.today {
        border-color: var(--accent);
    }
    .flatpickr-weekday {
        color: var(--accent);
        font-weight: 600;
    }
    .flatpickr-monthDropdown-months .flatpickr-monthDropdown-month,
    .flatpickr-current-month .numInputWrapper .numInput,
    .flatpickr-current-month .flatpickr-monthDropdown-months {
        background-color: var(--input-bg);
        color: var(--text);
        border: 1px solid var(--border);
    }
    .flatpickr-current-month .flatpickr-monthDropdown-months:hover {
        background: color-mix(in srgb, var(--accent) 10%, var(--input-bg));
    }
    span.arrowUp::after, span.arrowDown::after {
        border-bottom-color: var(--text);
        border-top-color: var(--text);
    }

</style>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
</head>
<body data-theme="light">

<!-- Spinner de Carregamento -->
<div id="spinner">
  Carregando dados...
</div>

<header>
  <div style="display:flex; align-items:center; gap:10px;">
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-clipboard-data" viewBox="0 0 16 16" style="color: var(--accent); transition: color var(--transition-speed) ease;">
      <path d="M4 11a1 1 0 1 1 2 0v1a1 1 0 1 1-2 0zm6-4a1 1 0 1 1 2 0v5a1 1 0 1 1-2 0zM7 9a1 1 0 0 1 2 0v3a1 1 0 1 1-2 0z"/>
      <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/>
      <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"/>
    </svg>
    <span style="font-weight: 600; font-size: 1.2rem;">Painel Consultas</span>
  </div>
  <h2 class="hidden" id="tituloPainel">Painel de Consulta de Currículos</h2>
  <button id="theme-toggle" onclick="alternarTema()" title="Alternar Tema">
    <span id="theme-icon">🌙</span> <!-- Ícone será atualizado via JS -->
  </button>
</header>

<!-- Tela de Login -->
<div class="login">
  <h2>🔐 Acesso ao Painel</h2>
  <p>Digite a senha para visualizar os dados:</p>
  <input id="senha" placeholder="Senha" type="text"/>
  <button onclick="verificarSenha()">Entrar</button>
</div>

<!-- Conteúdo Principal do Painel -->
<div class="painel hidden">
  <div class="action-buttons">
    <button onclick="exportarExcel()">📁 Exportar CSV</button>
    <button onclick="exportarXLSX()">📊 Exportar XLSX</button>
    <button class="exportar" onclick="atualizar()">
      🔄 Atualizar Agora
    </button>
  </div>

  <div class="filtros">
    <input id="filtroCpf" placeholder="CPF" type="text"/>
    <input id="filtroTelefone" placeholder="Telefone" type="text"/>
    <input id="filtroCidade" list="cidades" placeholder="Cidade"/>
    <datalist id="cidades"></datalist>
    <input id="filtroBairro" list="bairros" placeholder="Bairro"/>
    <datalist id="bairros"></datalist>
    <input id="filtroVaga" list="vagas" placeholder="Vaga"/>
    <datalist id="vagas"></datalist>
    <input id="dataInicio" placeholder="Data Início" type="text" class="flatpickr-input"/>
    <input id="dataFim" placeholder="Data Fim" type="text" class="flatpickr-input"/>
    <button onclick="atualizar()">🔎 Buscar</button>
    <button onclick="limparFiltros()">🧹 Limpar Filtros</button>
  </div>

  <table id="tabelaCurriculos">
    <thead>
      <tr>
        <th>Nome</th><th>CPF</th><th>Telefone</th><th>Cidade</th><th>Bairro</th><th>Vaga</th><th>Data</th><th>Currículo</th>
      </tr>
    </thead>
    <tbody>
      <!-- Dados serão preenchidos via JavaScript -->
      <!-- Mensagem de erro/fallback será inserida aqui se necessário -->
    </tbody>
  </table>

  <div class="paginacao" id="paginacao">
    <!-- Paginação será gerada via JavaScript -->
  </div>

  <div class="chart-container">
    <canvas id="graficoVagas"></canvas>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/inputmask/dist/inputmask.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
  // --- Configuração Inicial e Variáveis Globais ---
  let dadosOriginais = [];
  let dadosFiltrados = [];
  let paginaAtual = 1;
  const itensPorPagina = 15;
  let chartInstance = null;
  let ultimaQuantidade = 0;
  const senhaCorreta = "Vemserpop";
  let dadosCarregadosComSucesso = false;

  // --- Elementos DOM ---
  // Adiciona verificações para garantir que os elementos existem
  const spinner = document.getElementById('spinner');
  if (!spinner) console.error("Elemento #spinner não encontrado!");
  const loginDiv = document.querySelector('.login');
  if (!loginDiv) console.error("Elemento .login não encontrado!");
  const painelDiv = document.querySelector('.painel');
  if (!painelDiv) console.error("Elemento .painel não encontrado!");
  const tituloPainel = document.getElementById('tituloPainel');
  if (!tituloPainel) console.error("Elemento #tituloPainel não encontrado!");
  const senhaInput = document.getElementById('senha');
  if (!senhaInput) console.error("Elemento #senha não encontrado!");
  const filtroCpf = document.getElementById('filtroCpf');
  const filtroTelefone = document.getElementById('filtroTelefone');
  const filtroCidade = document.getElementById('filtroCidade');
  const filtroBairro = document.getElementById('filtroBairro');
  const filtroVaga = document.getElementById('filtroVaga');
  const dataInicioInput = document.getElementById('dataInicio');
  const dataFimInput = document.getElementById('dataFim');
  const tabelaBody = document.querySelector('#tabelaCurriculos tbody');
  if (!tabelaBody) console.error("Elemento #tabelaCurriculos tbody não encontrado!");
  const paginacaoDiv = document.getElementById('paginacao');
  const graficoCanvas = document.getElementById('graficoVagas');
  const themeToggleButton = document.getElementById('theme-toggle');
  const themeIcon = document.getElementById('theme-icon');

  // --- Funções Principais ---

  // Função para mostrar/ocultar o spinner
  function toggleSpinner(show) {
      if (spinner) {
          console.log(show ? "Mostrando spinner" : "Escondendo spinner");
          spinner.style.display = show ? 'flex' : 'none';
      } else {
          console.error("Elemento spinner não encontrado em toggleSpinner!");
      }
  }

  // Função de Login
  function verificarSenha() {
    console.log("verificarSenha chamada");
    // Verifica se os elementos essenciais existem
    if (!loginDiv || !painelDiv || !tituloPainel || !senhaInput) {
        console.error("Erro: Elementos essenciais do DOM não encontrados em verificarSenha.");
        alert("Erro interno. Por favor, recarregue a página.");
        return;
    }
    if (senhaInput.value === senhaCorreta) {
      console.log("Senha correta. Escondendo login e mostrando painel.");
      loginDiv.classList.add('hidden');
      painelDiv.classList.remove('hidden'); // Mostra o painel
      tituloPainel.classList.remove('hidden'); // Mostra o título
      painelDiv.style.animation = 'fadeInUp 0.8s ease-out';
      console.log("Chamando carregarDadosIniciais...");
      carregarDadosIniciais(); // Chama a função para carregar os dados
    } else {
      console.log("Senha incorreta.");
      alert('Senha incorreta.');
      senhaInput.value = '';
      senhaInput.focus();
    }
  }

  // Função para Carregar Dados Iniciais (com fallback)
  async function carregarDadosIniciais() {
    console.log("carregarDadosIniciais iniciada.");
    toggleSpinner(true); // Mostra o spinner
    try {
      console.log("Tentando fetch dos dados...");
      const response = await fetch('https://raw.githubusercontent.com/PopularAtacarejo/VagasPopular/main/dados.json');
      console.log("Fetch status:", response.status);
      if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
      }
      dadosOriginais = await response.json();
      dadosCarregadosComSucesso = true;
      console.log("Dados carregados com sucesso:", dadosOriginais.length, "registros.");
      aplicarFiltros(); // Renderiza a tabela com os dados

    } catch (error) {
      console.error('Erro ao buscar dados iniciais:', error);
      dadosCarregadosComSucesso = false;
      dadosOriginais = []; // Garante que dadosOriginais está vazio
      console.log("Erro no fetch. Chamando aplicarFiltros para fallback.");
      aplicarFiltros(); // Renderiza a tabela com a mensagem de erro
      alert('Falha ao carregar os dados externos. O painel será exibido com funcionalidades limitadas.');
    } finally {
      console.log("Bloco finally de carregarDadosIniciais. Escondendo spinner.");
      toggleSpinner(false); // Esconde o spinner independentemente do resultado
    }
  }

  // Função para Aplicar Filtros e Atualizar a Visualização
  function aplicarFiltros() {
      console.log("aplicarFiltros chamada.");
      const cpf = filtroCpf?.value.trim().toLowerCase() || '';
      const tel = filtroTelefone?.value.trim().toLowerCase() || '';
      const cidade = filtroCidade?.value.trim().toLowerCase() || '';
      const bairro = filtroBairro?.value.trim().toLowerCase() || '';
      const vaga = filtroVaga?.value.trim().toLowerCase() || '';
      const ini = dataInicioInput?._flatpickr?.selectedDates[0];
      const fim = dataFimInput?._flatpickr?.selectedDates[0] ? new Date(dataFimInput._flatpickr.selectedDates[0].getTime() + 86399999) : null;

      // Filtra a partir dos dados originais
      dadosFiltrados = dadosOriginais.filter(p => {
        const dataCandidato = p.data ? new Date(p.data) : null;
        return (!cpf || (p.cpf || '').toLowerCase().includes(cpf)) &&
               (!tel || (p.telefone || '').toLowerCase().includes(tel)) &&
               (!cidade || (p.cidade || '').toLowerCase().includes(cidade)) &&
               (!bairro || (p.bairro || '').toLowerCase().includes(bairro)) &&
               (!vaga || (p.vaga || '').toLowerCase() === vaga) &&
               (!ini || (dataCandidato && dataCandidato >= ini)) &&
               (!fim || (dataCandidato && dataCandidato <= fim));
      });
      console.log("Dados filtrados:", dadosFiltrados.length);

      // Ordena se houver dados
      if (dadosFiltrados.length > 0) {
          dadosFiltrados.sort((a, b) => new Date(b.data) - new Date(a.data));
      }

      // Notifica apenas se os dados foram carregados com sucesso
      if (dadosCarregadosComSucesso) {
          notificarNovosDados(dadosFiltrados.length);
      }

      // Preenche datalists apenas se houver dados originais
      if (dadosOriginais.length > 0) {
          preencherDatalist(dadosOriginais, 'cidade', 'cidades');
          preencherDatalist(dadosOriginais, 'bairro', 'bairros');
          preencherDatalist(dadosOriginais, 'vaga', 'vagas');
      }

      paginaAtual = 1;
      renderTabela();
      renderPaginacao();
      renderGrafico();
      console.log("Renderização concluída após aplicarFiltros.");
  }

  // Função de Atualização chamada pelo botão
  async function atualizar() {
      console.log("Botão Atualizar clicado.");
      if (dadosCarregadosComSucesso) {
          aplicarFiltros();
      } else {
          console.log("Tentando recarregar dados...");
          await carregarDadosIniciais();
      }
  }

  // Renderiza a Tabela com os Dados Paginados
  function renderTabela() {
    console.log("renderTabela chamada. Página:", paginaAtual);
    if (!tabelaBody) {
        console.error("Elemento tbody não encontrado em renderTabela!");
        return;
    }
    tabelaBody.innerHTML = ''; // Limpa a tabela
    const inicio = (paginaAtual - 1) * itensPorPagina;
    const fim = inicio + itensPorPagina;
    const dadosPagina = dadosFiltrados.slice(inicio, fim);
    console.log(`Mostrando itens ${inicio} a ${fim-1} de ${dadosFiltrados.length}`);

    // Verifica se houve falha no carregamento inicial E não há dados originais
    if (!dadosCarregadosComSucesso && dadosOriginais.length === 0) {
        console.log("Renderizando mensagem de erro de carregamento.");
        const row = tabelaBody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = 8;
        cell.textContent = '⚠️ Erro ao carregar dados externos. Funcionalidades limitadas.';
        cell.classList.add('table-message');
        return;
    }

    // Verifica se não há dados após aplicar filtros
    if (dadosFiltrados.length === 0 && dadosCarregadosComSucesso) {
        console.log("Renderizando mensagem 'Nenhum currículo encontrado'.");
        const row = tabelaBody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = 8;
        cell.textContent = 'Nenhum currículo encontrado com os filtros aplicados.';
        cell.style.textAlign = 'center';
        cell.style.padding = '2rem';
        cell.style.fontStyle = 'italic';
        return;
    }

    // Renderiza as linhas da tabela
    console.log("Renderizando linhas da tabela...");

    dadosPagina.forEach((p, index) => {
      const row = tabelaBody.insertRow();
      row.insertCell().textContent = p.nome || 'N/A';
      row.insertCell().textContent = p.cpf || 'N/A';
      row.insertCell().textContent = p.telefone || 'N/A';
      row.insertCell().textContent = p.cidade || 'N/A';
      row.insertCell().textContent = p.bairro || 'N/A';
      row.insertCell().textContent = p.vaga || 'N/A';
      row.insertCell().textContent = p.data ? new Date(p.data).toLocaleDateString('pt-BR') : 'N/A';
      const cellLink = row.insertCell();
      if (p.arquivo && typeof p.arquivo === 'string' && p.arquivo.trim() !== '') {
          const link = document.createElement('a');
          link.href = p.arquivo;
          link.textContent = 'Ver Currículo';
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          cellLink.appendChild(link);
      } else {
          cellLink.textContent = 'Sem link';
      }
      row.style.opacity = '0';
      row.style.animation = `fadeInUp 0.5s ease-out forwards`;
      row.style.animationDelay = `${index * 0.05}s`;
    });
    console.log("Linhas da tabela renderizadas.");
  }

  // Renderiza a Paginação
  function renderPaginacao() {
    console.log("renderPaginacao chamada.");
    if (!paginacaoDiv) {
        console.error("Elemento paginacaoDiv não encontrado!");
        return;
    }
    paginacaoDiv.innerHTML = '';
    const totalPaginas = Math.ceil(dadosFiltrados.length / itensPorPagina);
    console.log("Total de páginas:", totalPaginas);

    if (totalPaginas <= 1) return;

    const btnPrev = document.createElement('button');
    btnPrev.textContent = '«';
    btnPrev.disabled = paginaAtual === 1;
    btnPrev.onclick = () => mudarPagina(paginaAtual - 1);
    paginacaoDiv.appendChild(btnPrev);

    const maxBotoesVisiveis = 5;
    let inicioPag = Math.max(1, paginaAtual - Math.floor(maxBotoesVisiveis / 2));
    let fimPag = Math.min(totalPaginas, inicioPag + maxBotoesVisiveis - 1);

    if (fimPag - inicioPag + 1 < maxBotoesVisiveis) {
        inicioPag = Math.max(1, fimPag - maxBotoesVisiveis + 1);
    }

    if (inicioPag > 1) {
        const btnFirst = document.createElement('button');
        btnFirst.textContent = '1';
        btnFirst.onclick = () => mudarPagina(1);
        paginacaoDiv.appendChild(btnFirst);
        if (inicioPag > 2) {
            const span = document.createElement('span');
            span.textContent = '...';
            span.style.margin = '0 0.5rem';
            paginacaoDiv.appendChild(span);
        }
    }

    for (let i = inicioPag; i <= fimPag; i++) {
      const btn = document.createElement('button');
      btn.textContent = i;
      if (i === paginaAtual) {
        btn.classList.add('active');
        btn.disabled = true;
      } else {
        btn.onclick = () => mudarPagina(i);
      }
      paginacaoDiv.appendChild(btn);
    }

    if (fimPag < totalPaginas) {
        if (fimPag < totalPaginas - 1) {
            const span = document.createElement('span');
            span.textContent = '...';
            span.style.margin = '0 0.5rem';
            paginacaoDiv.appendChild(span);
        }
        const btnLast = document.createElement('button');
        btnLast.textContent = totalPaginas;
        btnLast.onclick = () => mudarPagina(totalPaginas);
        paginacaoDiv.appendChild(btnLast);
    }

    const btnNext = document.createElement('button');
    btnNext.textContent = '»';
    btnNext.disabled = paginaAtual === totalPaginas;
    btnNext.onclick = () => mudarPagina(paginaAtual + 1);
    paginacaoDiv.appendChild(btnNext);
    console.log("Paginação renderizada.");
  }

  // Muda a Página Atual e Re-renderiza
  function mudarPagina(novaPagina) {
    console.log("Mudando para página:", novaPagina);
    paginaAtual = novaPagina;
    renderTabela();
    renderPaginacao();
    if (tabelaBody) {
        window.scrollTo({ top: tabelaBody.offsetTop - 80, behavior: 'smooth' });
    }
  }

  // Renderiza o Gráfico de Vagas
  function renderGrafico() {
    console.log("renderGrafico chamada.");
    if (!graficoCanvas) {
        console.warn("Elemento graficoCanvas não encontrado!");
        return;
    }
    const ctx = graficoCanvas.getContext('2d');
    if (!ctx) {
        console.error("Não foi possível obter contexto 2D do canvas.");
        return;
    }

    // Limpa o gráfico anterior
    if (chartInstance) {
      console.log("Destruindo instância anterior do gráfico.");
      chartInstance.destroy();
      chartInstance = null;
    }

    // Não renderiza se não houver dados
    if (dadosFiltrados.length === 0) {
        console.log("Sem dados filtrados para o gráfico. Limpando canvas.");
        ctx.clearRect(0, 0, graficoCanvas.width, graficoCanvas.height);
        return;
    }

    const contagemVagas = dadosFiltrados.reduce((acc, curr) => {
      const vaga = curr.vaga || 'Não especificada';
      acc[vaga] = (acc[vaga] || 0) + 1;
      return acc;
    }, {});
    console.log("Contagem de vagas para gráfico:", contagemVagas);

    const labels = Object.keys(contagemVagas);
    const data = Object.values(contagemVagas);

    const theme = document.body.getAttribute('data-theme');
    const gridColor = theme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
    const labelColor = theme === 'dark' ? '#e9ecef' : '#495057';
    const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();

    try {
        chartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Número de Currículos por Vaga',
              data: data,
              backgroundColor: colorMix(accentColor, 0.7),
              borderColor: accentColor,
              borderWidth: 1,
              borderRadius: 5,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)'
                }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                    color: labelColor,
                    precision: 0
                },
                grid: {
                    color: gridColor
                }
              },
              x: {
                ticks: {
                    color: labelColor
                },
                grid: {
                    display: false
                }
              }
            }
          }
        });
        console.log("Gráfico renderizado com sucesso.");
    } catch (chartError) {
        console.error("Erro ao criar o gráfico:", chartError);
    }
  }

  // Função auxiliar para misturar cores
  function colorMix(color, opacity) {
      if (!color.startsWith('#') || color.length !== 7) {
          // console.warn('Formato de cor inválido para colorMix:', color);
          const defaultAccent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
          color = (defaultAccent.startsWith('#') && defaultAccent.length === 7) ? defaultAccent : '#000000'; // Fallback para preto
      }
      let r = parseInt(color.slice(1, 3), 16);
      let g = parseInt(color.slice(3, 5), 16);
      let b = parseInt(color.slice(5, 7), 16);
      return `rgba(${r}, ${g}, ${b}, ${opacity})`;
  }

  // Preenche Datalists para Autocomplete
  function preencherDatalist(dados, campo, datalistId) {
    const datalist = document.getElementById(datalistId);
    if (!datalist) {
        console.warn(`Datalist #${datalistId} não encontrado.`);
        return;
    }
    const currentOptionsValues = new Set([...datalist.options].map(opt => opt.value));
    const novosValores = new Set(dados.map(p => p[campo]).filter(Boolean));

    novosValores.forEach(valor => {
        if (!currentOptionsValues.has(valor)) {
            const option = document.createElement('option');
            option.value = valor;
            datalist.appendChild(option);
        }
    });
  }

  // Limpa os Filtros e Atualiza
  function limparFiltros() {
    console.log("Limpando filtros...");
    if(filtroCpf) filtroCpf.value = '';
    if(filtroTelefone) filtroTelefone.value = '';
    if(filtroCidade) filtroCidade.value = '';
    if(filtroBairro) filtroBairro.value = '';
    if(filtroVaga) filtroVaga.value = '';
    dataInicioInput?._flatpickr?.clear();
    dataFimInput?._flatpickr?.clear();
    aplicarFiltros();
  }

  // Notifica sobre Novos Dados
  function notificarNovosDados(qtdAtual) {
    if (dadosCarregadosComSucesso && ultimaQuantidade !== 0 && qtdAtual > ultimaQuantidade) {
      const novos = qtdAtual - ultimaQuantidade;
      console.log(`Notificando ${novos} novo(s) currículo(s).`);
      const aviso = document.createElement('div');
      aviso.className = 'notification';
      aviso.innerHTML = `🔔 <strong>${novos}</strong> novo(s) currículo(s) recebido(s)!`;
      document.body.appendChild(aviso);
      setTimeout(() => {
          aviso.style.animation = 'slideOutDown 0.5s ease-in forwards';
          setTimeout(() => aviso.remove(), 500);
      }, 6000);
    }
    if (dadosCarregadosComSucesso) {
        ultimaQuantidade = qtdAtual;
    }
  }

  // Exporta Dados para Excel (CSV)
  function exportarExcel() {
    console.log("Tentando exportar para CSV...");
    try {
        if (dadosFiltrados.length === 0) {
            alert('Não há dados filtrados para exportar.');
            return;
        }
        const dataExport = dadosFiltrados.map(({ nome, cpf, telefone, cidade, bairro, vaga, data, link }) => ({ Nome: nome, CPF: cpf, Telefone: telefone, Cidade: cidade, Bairro: bairro, Vaga: vaga, Data: data ? new Date(data).toLocaleDateString('pt-BR') : '', Link: link }));
        const worksheet = XLSX.utils.json_to_sheet(dataExport);
        const csv = XLSX.utils.sheet_to_csv(worksheet);
        const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
        const linkElement = document.createElement('a');
        linkElement.href = URL.createObjectURL(blob);
        linkElement.download = 'curriculos.csv';
        linkElement.style.display = 'none';
        document.body.appendChild(linkElement);
        linkElement.click();
        document.body.removeChild(linkElement);
        URL.revokeObjectURL(linkElement.href);
        console.log("Exportação CSV bem-sucedida.");
    } catch (error) {
        console.error('Erro ao exportar CSV:', error);
        alert('Ocorreu um erro ao tentar exportar os dados para CSV.');
    }
  }

  // Exporta Dados para Excel (XLSX)
  function exportarXLSX() {
    console.log("Tentando exportar para XLSX...");
    try {
        if (dadosFiltrados.length === 0) {
            alert('Não há dados filtrados para exportar.');
            return;
        }
        const dataExport = dadosFiltrados.map(({ nome, cpf, telefone, cidade, bairro, vaga, data, link }) => ({ Nome: nome, CPF: cpf, Telefone: telefone, Cidade: cidade, Bairro: bairro, Vaga: vaga, Data: data ? new Date(data) : null, Link: link }));
        const worksheet = XLSX.utils.json_to_sheet(dataExport);
        const range = XLSX.utils.decode_range(worksheet['!ref']);
        // Formatar coluna de data
        for (let R = range.s.r + 1; R <= range.e.r; ++R) {
            const cell_address = { c: 6, r: R }; // Coluna G (índice 6)
            const cell_ref = XLSX.utils.encode_cell(cell_address);
            if (worksheet[cell_ref] && worksheet[cell_ref].v instanceof Date) {
                worksheet[cell_ref].t = 'd';
                worksheet[cell_ref].z = 'dd/mm/yyyy';
            }
        }
        // Ajustar largura das colunas
        const colWidths = [];
        for (let C = range.s.c; C <= range.e.c; ++C) {
            let maxLen = 0;
            // Verifica o cabeçalho
            const header_cell_ref = XLSX.utils.encode_cell({c: C, r: range.s.r});
            if (worksheet[header_cell_ref]) {
                 maxLen = Math.max(maxLen, XLSX.utils.format_cell(worksheet[header_cell_ref]).length);
            }
            // Verifica as células de dados
            for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                const cell_address = { c: C, r: R };
                const cell_ref = XLSX.utils.encode_cell(cell_address);
                if (worksheet[cell_ref]) {
                    const cellText = XLSX.utils.format_cell(worksheet[cell_ref]);
                    maxLen = Math.max(maxLen, cellText.length);
                }
            }
            colWidths.push({ wch: maxLen + 2 }); // Adiciona um padding
        }
        worksheet['!cols'] = colWidths;

        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Currículos');
        XLSX.writeFile(workbook, 'curriculos.xlsx');
        console.log("Exportação XLSX bem-sucedida.");
    } catch (error) {
        console.error('Erro ao exportar XLSX:', error);
        alert('Ocorreu um erro ao tentar exportar os dados para XLSX.');
    }
  }

  // Alterna entre Tema Claro e Escuro
  function alternarTema() {
    const currentTheme = document.body.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    console.log(`Mudando tema para: ${newTheme}`);
    document.body.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeIcon(newTheme);
    if (chartInstance) {
        console.log("Re-renderizando gráfico para novo tema.");
        renderGrafico();
    }
  }

  // Atualiza o ícone do botão de tema
  function updateThemeIcon(theme) {
      if(themeIcon) themeIcon.textContent = theme === 'light' ? '🌙' : '☀️';
      if(themeToggleButton) themeToggleButton.title = theme === 'light' ? 'Mudar para Tema Escuro' : 'Mudar para Tema Claro';
  }

  // --- Inicialização ---
  document.addEventListener('DOMContentLoaded', () => {
    console.log("DOMContentLoaded disparado.");

    // Verifica novamente se os elementos principais existem antes de usá-los
    if (!spinner || !loginDiv || !painelDiv || !tituloPainel || !senhaInput || !tabelaBody) {
        console.error("Falha crítica: Elementos essenciais do DOM não encontrados na inicialização. Abortando.");
        alert("Erro crítico na inicialização da página. Por favor, recarregue.");
        return;
    }

    // Aplica máscaras
    try {
        if(filtroCpf) Inputmask({ mask: '999.999.999-99', clearIncomplete: true }).mask(filtroCpf);
        if(filtroTelefone) Inputmask({ mask: ['(99) 9999-9999', '(99) 99999-9999'], keepStatic: true, clearIncomplete: true }).mask(filtroTelefone);
    } catch (maskError) {
        console.error("Erro ao aplicar Inputmask:", maskError);
    }

    // Inicializa Flatpickr
    try {
        if(dataInicioInput) flatpickr(dataInicioInput, { dateFormat: 'Y-m-d', altInput: true, altFormat: 'd/m/Y', locale: 'pt' });
        if(dataFimInput) flatpickr(dataFimInput, { dateFormat: 'Y-m-d', altInput: true, altFormat: 'd/m/Y', locale: 'pt' });
    } catch (flatpickrError) {
        console.error("Erro ao inicializar Flatpickr:", flatpickrError);
    }

    // Verifica tema salvo
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.body.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);

    // Configura visibilidade inicial
    console.log("Configurando visibilidade inicial login/painel.");
    painelDiv.classList.add('hidden');
    loginDiv.classList.remove('hidden');
    tituloPainel.classList.add('hidden');
    toggleSpinner(false); // Garante que o spinner está escondido

    // Foca no campo de senha
    senhaInput.focus();

    // Adiciona listener para Enter
    senhaInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            console.log("Enter pressionado no campo de senha.");
            verificarSenha();
        }
    });

    console.log("Inicialização concluída.");
  });

</script>

</body>
</html>

